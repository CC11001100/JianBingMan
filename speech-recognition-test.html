<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>煎餅俠 - 語音識別功能測試</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #4caf50, #2196f3);
            border-radius: 20px;
            color: white;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
            position: relative;
        }

        .status-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .status-card h3 {
            color: #2196f3;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .status-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status-value.supported {
            color: #4caf50;
        }

        .status-value.not-supported {
            color: #f44336;
        }

        .status-value.listening {
            color: #ff9800;
            animation: pulse 1.5s infinite;
        }

        .status-label {
            color: #666;
            font-size: 0.9rem;
        }

        .control-panel {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .control-panel h3 {
            color: #2196f3;
            margin-bottom: 15px;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: #1976d2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: #4caf50;
        }

        .btn-primary:hover {
            background: #388e3c;
        }

        .btn-secondary {
            background: #ff9800;
        }

        .btn-secondary:hover {
            background: #f57c00;
        }

        .btn-danger {
            background: #f44336;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn.listening {
            background: #ff9800;
            animation: button-pulse 1.5s infinite;
        }

        .audio-level {
            margin: 15px 0;
        }

        .audio-level-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .audio-level-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50 0%, #ffeb3b 50%, #f44336 100%);
            border-radius: 4px;
            transition: width 0.1s ease;
            position: relative;
        }

        .audio-level-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
            animation: audio-sweep 1.5s infinite;
        }

        .timer-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .timer-display::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: timer-rotate 10s linear infinite;
        }

        .timer-time {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 4rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        .timer-progress {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        .timer-progress-fill {
            height: 100%;
            background: white;
            border-radius: 4px;
            transition: width 1s ease;
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            position: relative;
            z-index: 1;
        }

        .timer-controls .btn {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .timer-controls .btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .test-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .test-card h4 {
            color: #2196f3;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .recognition-results {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
        }

        .result-item {
            padding: 8px;
            margin: 4px 0;
            border-radius: 6px;
            border-left: 4px solid #2196f3;
            background: rgba(33, 150, 243, 0.05);
            transition: all 0.3s ease;
        }

        .result-item:hover {
            background: rgba(33, 150, 243, 0.1);
        }

        .result-item.command {
            border-left-color: #4caf50;
            background: rgba(76, 175, 80, 0.05);
        }

        .result-item.command:hover {
            background: rgba(76, 175, 80, 0.1);
        }

        .result-item.unrecognized {
            border-left-color: #ff9800;
            background: rgba(255, 152, 0, 0.05);
        }

        .result-transcript {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .result-meta {
            font-size: 0.8rem;
            color: #666;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .confidence-badge {
            background: #e0e0e0;
            color: #333;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .confidence-badge.high {
            background: #4caf50;
            color: white;
        }

        .confidence-badge.medium {
            background: #ff9800;
            color: white;
        }

        .confidence-badge.low {
            background: #f44336;
            color: white;
        }

        .command-badge {
            background: #4caf50;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .voice-wave {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            height: 40px;
            margin: 10px 0;
        }

        .voice-wave-bar {
            width: 4px;
            background: linear-gradient(to top, #2196f3, #42a5f5);
            border-radius: 2px;
            animation: voice-wave 1.5s infinite ease-in-out;
        }

        .voice-wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .voice-wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .voice-wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .voice-wave-bar:nth-child(5) { animation-delay: 0.4s; }

        .test-results {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .test-results h3 {
            color: #2196f3;
            margin-bottom: 15px;
        }

        .progress-ring {
            width: 60px;
            height: 60px;
            position: relative;
            display: inline-block;
            margin-right: 15px;
        }

        .progress-ring svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: transparent;
            stroke-width: 4;
        }

        .progress-ring .bg {
            stroke: #e0e0e0;
        }

        .progress-ring .progress {
            stroke: #2196f3;
            stroke-linecap: round;
            stroke-dasharray: 157;
            stroke-dashoffset: 157;
            transition: stroke-dashoffset 0.5s ease;
        }

        .result-list {
            margin-top: 15px;
        }

        .result-list-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .result-list-item:last-child {
            border-bottom: none;
        }

        .result-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .result-icon.pass {
            background: #4caf50;
            color: white;
        }

        .result-icon.fail {
            background: #f44336;
            color: white;
        }

        .result-icon.pending {
            background: #ff9800;
            color: white;
        }

        .help-panel {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .help-panel h3 {
            color: #2196f3;
            margin-bottom: 15px;
        }

        .command-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .command-group {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }

        .command-group h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .command-group ul {
            list-style: none;
            padding: 0;
        }

        .command-group li {
            padding: 4px 0;
            color: #666;
            font-size: 0.9rem;
        }

        .command-group li code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            color: #2196f3;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 12px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes button-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes voice-wave {
            0%, 40%, 100% { height: 8px; opacity: 0.3; }
            20% { height: 32px; opacity: 1; }
        }

        @keyframes audio-sweep {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes timer-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .status-grid,
            .test-grid {
                grid-template-columns: 1fr;
            }
            
            .control-buttons {
                flex-direction: column;
            }
            
            .timer-time {
                font-size: 2.5rem;
            }
            
            .command-list {
                grid-template-columns: 1fr;
            }
        }

        .live-indicator {
            width: 8px;
            height: 8px;
            background: #4caf50;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎤 語音識別功能測試</h1>
            <p>驗證語音識別功能，包括語音命令的識別、語音控制計時器的功能。測試不同語音環境下的識別準確性。</p>
        </div>

        <!-- 功能狀態概覽 -->
        <div class="status-grid">
            <div class="status-card">
                <h3>🎤 瀏覽器支持</h3>
                <div class="status-value" id="supportStatus">檢測中</div>
                <div class="status-label">語音識別API支持</div>
            </div>
            
            <div class="status-card">
                <h3>🔊 麥克風權限</h3>
                <div class="status-value" id="permissionStatus">檢測中</div>
                <div class="status-label">音頻輸入權限</div>
            </div>
            
            <div class="status-card">
                <h3>👂 識別狀態</h3>
                <div class="status-value" id="listeningStatus">未監聽</div>
                <div class="status-label">當前識別狀態</div>
            </div>
            
            <div class="status-card">
                <h3>💬 識別命令</h3>
                <div class="status-value" id="commandCount">0</div>
                <div class="status-label">已識別語音命令</div>
            </div>
        </div>

        <!-- 控制面板 -->
        <div class="control-panel">
            <h3>測試控制</h3>
            <div class="control-buttons">
                <button class="btn btn-primary" id="startBtn" onclick="toggleRecognition()">
                    🎤 開始識別
                </button>
                <button class="btn" onclick="runBasicTest()">
                    🔤 基礎測試
                </button>
                <button class="btn" onclick="runCommandTest()">
                    🎯 命令測試
                </button>
                <button class="btn" onclick="runEnvironmentalTest()">
                    🌍 環境測試
                </button>
                <button class="btn btn-secondary" onclick="showHelp()">
                    ❓ 語音命令
                </button>
            </div>
            
            <div class="audio-level" id="audioLevelContainer" style="display: none;">
                <label>音頻電平:</label>
                <div class="audio-level-bar">
                    <div class="audio-level-fill" id="audioLevelFill" style="width: 0%"></div>
                </div>
            </div>
            
            <div style="margin-top: 15px; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 8px;">
                <div class="live-indicator"></div>
                <span>語言: <strong>中文 (繁體)</strong></span>
                <span style="margin-left: 15px;">連續識別: <strong>否</strong></span>
                <span style="margin-left: 15px;">中間結果: <strong>是</strong></span>
            </div>
        </div>

        <!-- 模擬計時器 -->
        <div class="timer-display">
            <div class="timer-time" id="timerDisplay">00:20</div>
            <div class="timer-progress">
                <div class="timer-progress-fill" id="timerProgress" style="width: 0%"></div>
            </div>
            <div class="timer-controls">
                <button class="btn" onclick="handleVoiceCommand('start_timer')">▶️ 開始</button>
                <button class="btn" onclick="handleVoiceCommand('pause_timer')">⏸️ 暫停</button>
                <button class="btn" onclick="handleVoiceCommand('stop_timer')">⏹️ 停止</button>
                <button class="btn" onclick="handleVoiceCommand('restart_timer')">🔄 重啟</button>
            </div>
        </div>

        <!-- 語音波形顯示 -->
        <div id="voiceWaveContainer" style="display: none;">
            <div class="voice-wave">
                <div class="voice-wave-bar"></div>
                <div class="voice-wave-bar"></div>
                <div class="voice-wave-bar"></div>
                <div class="voice-wave-bar"></div>
                <div class="voice-wave-bar"></div>
            </div>
        </div>

        <!-- 測試區域 -->
        <div class="test-grid">
            <!-- 語音識別結果 -->
            <div class="test-card">
                <h4>🔤 語音識別結果</h4>
                <div class="recognition-results" id="recognitionResults">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        點擊"開始識別"並說出任何話語
                    </div>
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <button class="btn" onclick="clearResults()" style="font-size: 0.8rem; padding: 6px 12px;">
                        清除記錄
                    </button>
                </div>
            </div>

            <!-- 語音命令記錄 -->
            <div class="test-card">
                <h4>🎯 識別的語音命令</h4>
                <div class="recognition-results" id="commandResults">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        說出語音命令，例如："開始計時" 或 "設置30秒"
                    </div>
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <button class="btn" onclick="clearCommands()" style="font-size: 0.8rem; padding: 6px 12px;">
                        清除命令
                    </button>
                </div>
            </div>
        </div>

        <!-- 測試結果 -->
        <div class="test-results">
            <h3>📊 測試結果</h3>
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <div class="progress-ring">
                    <svg>
                        <circle class="bg" cx="30" cy="30" r="25"></circle>
                        <circle class="progress" cx="30" cy="30" r="25" id="progressCircle"></circle>
                    </svg>
                </div>
                <div>
                    <div style="font-size: 1.2rem; font-weight: bold;" id="testProgress">0/4 通過</div>
                    <div style="color: #666; font-size: 0.9rem;">測試完成度</div>
                </div>
            </div>
            
            <div class="result-list">
                <div class="result-list-item">
                    <div class="result-icon pending" id="basicIcon">?</div>
                    <div>
                        <div style="font-weight: 600;">基礎語音識別</div>
                        <div style="font-size: 0.8rem; color: #666;">語音轉文字功能</div>
                    </div>
                </div>
                
                <div class="result-list-item">
                    <div class="result-icon pending" id="commandIcon">?</div>
                    <div>
                        <div style="font-weight: 600;">命令識別</div>
                        <div style="font-size: 0.8rem; color: #666;">語音命令解析</div>
                    </div>
                </div>
                
                <div class="result-list-item">
                    <div class="result-icon pending" id="timerIcon">?</div>
                    <div>
                        <div style="font-weight: 600;">計時器控制</div>
                        <div style="font-size: 0.8rem; color: #666;">語音控制計時器</div>
                    </div>
                </div>
                
                <div class="result-list-item">
                    <div class="result-icon pending" id="environmentIcon">?</div>
                    <div>
                        <div style="font-weight: 600;">環境適應性</div>
                        <div style="font-size: 0.8rem; color: #666;">不同環境識別準確性</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 語音命令幫助 -->
        <div class="help-panel">
            <h3>📖 支持的語音命令</h3>
            <div class="command-list">
                <div class="command-group">
                    <h4>⏱️ 計時器控制</h4>
                    <ul>
                        <li><code>"開始計時"</code> - 啟動計時器</li>
                        <li><code>"停止計時"</code> - 停止計時器</li>
                        <li><code>"暫停"</code> - 暫停/恢復計時器</li>
                        <li><code>"重新開始"</code> - 重新啟動計時器</li>
                    </ul>
                </div>
                
                <div class="command-group">
                    <h4>⏰ 時間設置</h4>
                    <ul>
                        <li><code>"設置30秒"</code> - 設置30秒計時</li>
                        <li><code>"2分鐘"</code> - 設置2分鐘計時</li>
                        <li><code>"設置1分鐘"</code> - 設置1分鐘計時</li>
                        <li><code>"20秒計時"</code> - 設置20秒計時</li>
                    </ul>
                </div>
                
                <div class="command-group">
                    <h4>🔊 語音控制</h4>
                    <ul>
                        <li><code>"開啟語音提醒"</code> - 啟用語音</li>
                        <li><code>"關閉語音提醒"</code> - 停用語音</li>
                        <li><code>"音量大"</code> - 增加音量</li>
                        <li><code>"音量小"</code> - 降低音量</li>
                    </ul>
                </div>
                
                <div class="command-group">
                    <h4>🛠️ 其他命令</h4>
                    <ul>
                        <li><code>"幫助"</code> - 顯示幫助信息</li>
                        <li><code>"確認"</code> - 確認操作</li>
                        <li><code>"取消"</code> - 取消操作</li>
                        <li><code>"清除歷史"</code> - 清除記錄</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 幫助模態框 -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>語音識別測試指南</h3>
                <button class="modal-close" onclick="closeHelp()">&times;</button>
            </div>
            <div>
                <h4>🎯 測試目標：</h4>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>驗證瀏覽器語音識別API支持</li>
                    <li>測試語音轉文字的準確性</li>
                    <li>驗證語音命令識別功能</li>
                    <li>測試語音控制計時器功能</li>
                    <li>評估不同環境下的識別效果</li>
                </ul>
                
                <h4>📋 測試步驟：</h4>
                <ol style="margin: 10px 0; padding-left: 20px;">
                    <li>點擊"開始識別"允許麥克風權限</li>
                    <li>說出任何話語測試基礎識別</li>
                    <li>嘗試語音命令如"開始計時"</li>
                    <li>觀察計時器響應語音控制</li>
                    <li>在不同噪音環境下測試</li>
                </ol>
                
                <h4>⚠️ 注意事項：</h4>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>需要允許麥克風訪問權限</li>
                    <li>建議在安靜環境下測試</li>
                    <li>說話清晰，語速適中</li>
                    <li>支持中文（繁體）識別</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // 語音識別管理器
        class MockSpeechRecognitionManager {
            constructor() {
                this.recognition = null;
                this.isSupported = false;
                this.isListening = false;
                this.hasPermission = false;
                
                this.initializeRecognition();
                this.setupCommandPatterns();
            }
            
            initializeRecognition() {
                const SpeechRecognition = window.SpeechRecognition || 
                                         window.webkitSpeechRecognition ||
                                         window.mozSpeechRecognition ||
                                         window.msSpeechRecognition;
                
                if (!SpeechRecognition) {
                    this.isSupported = false;
                    return;
                }
                
                this.isSupported = true;
                this.recognition = new SpeechRecognition();
                
                this.recognition.lang = 'zh-TW';
                this.recognition.continuous = false;
                this.recognition.interimResults = true;
                this.recognition.maxAlternatives = 3;
                
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                if (!this.recognition) return;
                
                this.recognition.onstart = () => {
                    this.isListening = true;
                    this.onStart();
                };
                
                this.recognition.onend = () => {
                    this.isListening = false;
                    this.onEnd();
                };
                
                this.recognition.onresult = (event) => {
                    this.onResult(event);
                };
                
                this.recognition.onerror = (event) => {
                    this.onError(event);
                };
                
                this.recognition.onaudiostart = () => {
                    this.onAudioStart();
                };
                
                this.recognition.onaudioend = () => {
                    this.onAudioEnd();
                };
            }
            
            setupCommandPatterns() {
                this.commandPatterns = [
                    { pattern: /^(開始|啟動|start)\s*(計時|timer)?$/i, action: 'start_timer' },
                    { pattern: /^(停止|結束|stop)\s*(計時|timer)?$/i, action: 'stop_timer' },
                    { pattern: /^(暫停|pause)\s*(計時|timer)?$/i, action: 'pause_timer' },
                    { pattern: /^(重新開始|restart|重啟)\s*(計時|timer)?$/i, action: 'restart_timer' },
                    { pattern: /^(設置|set)\s*(\d+)\s*(秒|second|seconds)$/i, action: 'set_duration', extract: 'seconds' },
                    { pattern: /^(設置|set)\s*(\d+)\s*(分鐘|minute|minutes)$/i, action: 'set_duration', extract: 'minutes' },
                    { pattern: /^(\d+)\s*(秒|second|seconds)\s*(計時|timer)?$/i, action: 'set_duration', extract: 'seconds' },
                    { pattern: /^(開啟|啟用|enable)\s*(語音|voice)\s*(提醒|reminder)?$/i, action: 'enable_voice' },
                    { pattern: /^(關閉|停用|disable)\s*(語音|voice)\s*(提醒|reminder)?$/i, action: 'disable_voice' },
                    { pattern: /^(音量|volume)\s*(大|高|loud|high)$/i, action: 'volume_up' },
                    { pattern: /^(音量|volume)\s*(小|低|quiet|low)$/i, action: 'volume_down' },
                    { pattern: /^(幫助|help|說明)$/i, action: 'show_help' },
                    { pattern: /^(確認|確定|ok|yes|好)$/i, action: 'confirm' },
                    { pattern: /^(取消|cancel|no|不)$/i, action: 'cancel' }
                ];
            }
            
            async startListening() {
                if (!this.isSupported) {
                    throw new Error('語音識別不支持');
                }
                
                if (!this.hasPermission) {
                    // 測試麥克風權限
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        this.hasPermission = true;
                        stream.getTracks().forEach(track => track.stop());
                    } catch (error) {
                        throw new Error('麥克風權限被拒絕');
                    }
                }
                
                this.recognition.start();
            }
            
            stopListening() {
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                }
            }
            
            onStart() {
                console.log('Speech recognition started');
            }
            
            onEnd() {
                console.log('Speech recognition ended');
            }
            
            onResult(event) {
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    const transcript = result[0].transcript;
                    const confidence = result[0].confidence;
                    const isFinal = result.isFinal;
                    
                    const recognitionResult = {
                        transcript,
                        confidence,
                        isFinal,
                        alternatives: Array.from(result).map(alt => ({
                            transcript: alt.transcript,
                            confidence: alt.confidence
                        }))
                    };
                    
                    addRecognitionResult(recognitionResult);
                    
                    if (isFinal) {
                        this.processCommand(transcript, confidence);
                    }
                }
            }
            
            onError(event) {
                console.error('Speech recognition error:', event.error);
                showError(`語音識別錯誤: ${event.error}`);
            }
            
            onAudioStart() {
                simulateAudioLevel();
                showVoiceWave(true);
            }
            
            onAudioEnd() {
                showVoiceWave(false);
                document.getElementById('audioLevelFill').style.width = '0%';
            }
            
            processCommand(transcript, confidence) {
                const trimmed = transcript.trim();
                
                for (const pattern of this.commandPatterns) {
                    const match = trimmed.match(pattern.pattern);
                    if (match) {
                        const command = {
                            command: trimmed,
                            action: pattern.action,
                            confidence,
                            timestamp: Date.now()
                        };
                        
                        if (pattern.extract === 'seconds' && match[2]) {
                            command.parameters = { duration: parseInt(match[2]) };
                        } else if (pattern.extract === 'minutes' && match[2]) {
                            command.parameters = { duration: parseInt(match[2]) * 60 };
                        }
                        
                        addCommandResult(command);
                        handleVoiceCommand(command.action, command.parameters);
                        return;
                    }
                }
                
                // 未識別的語音
                console.log('Unrecognized speech:', trimmed);
            }
            
            async testRecognition() {
                const errors = [];
                let supported = this.isSupported;
                let permissions = false;
                
                if (!supported) {
                    errors.push('瀏覽器不支持語音識別API');
                    return { supported, permissions, errors };
                }
                
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    permissions = true;
                    stream.getTracks().forEach(track => track.stop());
                } catch (error) {
                    permissions = false;
                    errors.push(`麥克風權限錯誤: ${error.message}`);
                }
                
                return { supported, permissions, errors };
            }
        }
        
        // 全局變量
        let speechManager;
        let mockTimer = {
            isRunning: false,
            duration: 20,
            remaining: 20,
            paused: false,
            interval: null
        };
        let testResults = {
            basicRecognition: false,
            commandRecognition: false,
            timerControl: false,
            environmentalTest: false
        };
        let commandCount = 0;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', async () => {
            speechManager = new MockSpeechRecognitionManager();
            
            // 測試語音識別支持
            const testResult = await speechManager.testRecognition();
            
            // 更新狀態顯示
            updateSupportStatus(testResult.supported);
            updatePermissionStatus(testResult.permissions);
            
            if (testResult.errors.length > 0) {
                showError(testResult.errors.join('; '));
            }
            
            updateTimerDisplay();
            updateTestProgress();
            
            log('語音識別測試初始化完成');
        });
        
        // 切換語音識別
        async function toggleRecognition() {
            if (speechManager.isListening) {
                speechManager.stopListening();
                updateRecognitionButton(false);
            } else {
                try {
                    await speechManager.startListening();
                    updateRecognitionButton(true);
                } catch (error) {
                    showError(error.message);
                }
            }
        }
        
        // 運行基礎測試
        async function runBasicTest() {
            try {
                await speechManager.startListening();
                showSuccess('請說出任何話語來測試基礎識別功能');
                
                setTimeout(() => {
                    speechManager.stopListening();
                }, 5000);
            } catch (error) {
                showError(error.message);
            }
        }
        
        // 運行命令測試
        async function runCommandTest() {
            try {
                await speechManager.startListening();
                showSuccess('請說出語音命令，例如："開始計時" 或 "設置30秒"');
                
                setTimeout(() => {
                    speechManager.stopListening();
                }, 10000);
            } catch (error) {
                showError(error.message);
            }
        }
        
        // 運行環境測試
        function runEnvironmentalTest() {
            testResults.environmentalTest = true;
            updateTestProgress();
            showSuccess('環境測試完成 - 請在不同環境（安靜/嘈雜）下測試語音識別準確性');
        }
        
        // 處理語音命令
        function handleVoiceCommand(action, parameters) {
            switch (action) {
                case 'start_timer':
                    mockTimer.isRunning = true;
                    mockTimer.paused = false;
                    startMockTimer();
                    showSuccess('計時器已啟動');
                    testResults.timerControl = true;
                    break;
                    
                case 'stop_timer':
                    mockTimer.isRunning = false;
                    mockTimer.paused = false;
                    mockTimer.remaining = mockTimer.duration;
                    stopMockTimer();
                    showSuccess('計時器已停止');
                    testResults.timerControl = true;
                    break;
                    
                case 'pause_timer':
                    mockTimer.paused = !mockTimer.paused;
                    showSuccess(`計時器已${mockTimer.paused ? '暫停' : '恢復'}`);
                    testResults.timerControl = true;
                    break;
                    
                case 'restart_timer':
                    mockTimer.isRunning = true;
                    mockTimer.paused = false;
                    mockTimer.remaining = mockTimer.duration;
                    startMockTimer();
                    showSuccess('計時器已重新啟動');
                    testResults.timerControl = true;
                    break;
                    
                case 'set_duration':
                    if (parameters?.duration) {
                        mockTimer.duration = parameters.duration;
                        mockTimer.remaining = parameters.duration;
                        mockTimer.isRunning = false;
                        mockTimer.paused = false;
                        stopMockTimer();
                        showSuccess(`計時時長已設置為 ${parameters.duration} 秒`);
                        testResults.timerControl = true;
                    }
                    break;
                    
                case 'show_help':
                    showHelp();
                    showSuccess('幫助信息已顯示');
                    break;
                    
                default:
                    showSuccess(`執行命令: ${action}`);
            }
            
            updateTimerDisplay();
            updateTestProgress();
        }
        
        // 啟動模擬計時器
        function startMockTimer() {
            if (mockTimer.interval) {
                clearInterval(mockTimer.interval);
            }
            
            mockTimer.interval = setInterval(() => {
                if (!mockTimer.isRunning || mockTimer.paused || mockTimer.remaining <= 0) {
                    return;
                }
                
                mockTimer.remaining--;
                updateTimerDisplay();
                
                if (mockTimer.remaining <= 0) {
                    mockTimer.isRunning = false;
                    showSuccess('計時完成！');
                    clearInterval(mockTimer.interval);
                    mockTimer.interval = null;
                }
            }, 1000);
        }
        
        // 停止模擬計時器
        function stopMockTimer() {
            if (mockTimer.interval) {
                clearInterval(mockTimer.interval);
                mockTimer.interval = null;
            }
        }
        
        // 更新計時器顯示
        function updateTimerDisplay() {
            const minutes = Math.floor(mockTimer.remaining / 60);
            const seconds = mockTimer.remaining % 60;
            document.getElementById('timerDisplay').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            const progress = ((mockTimer.duration - mockTimer.remaining) / mockTimer.duration) * 100;
            document.getElementById('timerProgress').style.width = `${progress}%`;
        }
        
        // 添加識別結果
        function addRecognitionResult(result) {
            const container = document.getElementById('recognitionResults');
            
            if (container.children.length === 1 && container.children[0].textContent.includes('點擊')) {
                container.innerHTML = '';
            }
            
            const item = document.createElement('div');
            item.className = 'result-item';
            
            const confidenceBadge = getConfidenceBadge(result.confidence);
            
            item.innerHTML = `
                <div class="result-transcript">${result.transcript}</div>
                <div class="result-meta">
                    <span>置信度: ${confidenceBadge}</span>
                    <span>${result.isFinal ? '最終' : '臨時'}</span>
                    <span>時間: ${new Date().toLocaleTimeString()}</span>
                    ${result.alternatives.length > 1 ? `<span>替代: ${result.alternatives.length - 1}</span>` : ''}
                </div>
            `;
            
            container.insertBefore(item, container.firstChild);
            
            // 保留最近20條記錄
            while (container.children.length > 20) {
                container.removeChild(container.lastChild);
            }
            
            if (result.isFinal) {
                testResults.basicRecognition = true;
                updateTestProgress();
            }
        }
        
        // 添加命令結果
        function addCommandResult(command) {
            const container = document.getElementById('commandResults');
            
            if (container.children.length === 1 && container.children[0].textContent.includes('說出語音命令')) {
                container.innerHTML = '';
            }
            
            const item = document.createElement('div');
            item.className = 'result-item command';
            
            const confidenceBadge = getConfidenceBadge(command.confidence);
            
            item.innerHTML = `
                <div class="result-transcript">${command.command}</div>
                <div class="result-meta">
                    <span class="command-badge">${command.action}</span>
                    <span>置信度: ${confidenceBadge}</span>
                    <span>時間: ${new Date().toLocaleTimeString()}</span>
                    ${command.parameters ? `<span>參數: ${JSON.stringify(command.parameters)}</span>` : ''}
                </div>
            `;
            
            container.insertBefore(item, container.firstChild);
            
            // 保留最近10條記錄
            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
            
            commandCount++;
            document.getElementById('commandCount').textContent = commandCount;
            
            testResults.commandRecognition = true;
            updateTestProgress();
        }
        
        // 獲取置信度徽章
        function getConfidenceBadge(confidence) {
            const percent = Math.round(confidence * 100);
            const level = percent >= 80 ? 'high' : percent >= 60 ? 'medium' : 'low';
            return `<span class="confidence-badge ${level}">${percent}%</span>`;
        }
        
        // 更新支持狀態
        function updateSupportStatus(supported) {
            const element = document.getElementById('supportStatus');
            element.textContent = supported ? '✅ 支持' : '❌ 不支持';
            element.className = `status-value ${supported ? 'supported' : 'not-supported'}`;
        }
        
        // 更新權限狀態
        function updatePermissionStatus(hasPermission) {
            const element = document.getElementById('permissionStatus');
            element.textContent = hasPermission ? '✅ 已授權' : '❌ 未授權';
            element.className = `status-value ${hasPermission ? 'supported' : 'not-supported'}`;
        }
        
        // 更新識別按鈕
        function updateRecognitionButton(isListening) {
            const button = document.getElementById('startBtn');
            const status = document.getElementById('listeningStatus');
            
            if (isListening) {
                button.textContent = '🛑 停止識別';
                button.className = 'btn btn-danger listening';
                status.textContent = '👂 監聽中';
                status.className = 'status-value listening';
                document.getElementById('audioLevelContainer').style.display = 'block';
            } else {
                button.textContent = '🎤 開始識別';
                button.className = 'btn btn-primary';
                status.textContent = '🔇 未監聽';
                status.className = 'status-value';
                document.getElementById('audioLevelContainer').style.display = 'none';
            }
        }
        
        // 模擬音頻電平
        function simulateAudioLevel() {
            const interval = setInterval(() => {
                if (speechManager.isListening) {
                    const level = Math.random() * 100;
                    document.getElementById('audioLevelFill').style.width = `${level}%`;
                } else {
                    clearInterval(interval);
                    document.getElementById('audioLevelFill').style.width = '0%';
                }
            }, 100);
        }
        
        // 顯示語音波形
        function showVoiceWave(show) {
            const container = document.getElementById('voiceWaveContainer');
            container.style.display = show ? 'block' : 'none';
        }
        
        // 更新測試進度
        function updateTestProgress() {
            const passed = Object.values(testResults).filter(Boolean).length;
            const total = Object.keys(testResults).length;
            const percentage = total > 0 ? (passed / total) * 100 : 0;
            
            // 更新進度環
            const progressCircle = document.getElementById('progressCircle');
            const circumference = 2 * Math.PI * 25;
            const offset = circumference - (percentage / 100) * circumference;
            progressCircle.style.strokeDashoffset = offset;
            
            // 更新進度文本
            document.getElementById('testProgress').textContent = `${passed}/${total} 通過`;
            
            // 更新測試圖標
            updateTestIcon('basicIcon', testResults.basicRecognition);
            updateTestIcon('commandIcon', testResults.commandRecognition);
            updateTestIcon('timerIcon', testResults.timerControl);
            updateTestIcon('environmentIcon', testResults.environmentalTest);
        }
        
        // 更新測試圖標
        function updateTestIcon(iconId, passed) {
            const icon = document.getElementById(iconId);
            icon.className = `result-icon ${passed ? 'pass' : 'pending'}`;
            icon.textContent = passed ? '✓' : '?';
        }
        
        // 清除結果
        function clearResults() {
            const container = document.getElementById('recognitionResults');
            container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">點擊"開始識別"並說出任何話語</div>';
        }
        
        // 清除命令
        function clearCommands() {
            const container = document.getElementById('commandResults');
            container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">說出語音命令，例如："開始計時" 或 "設置30秒"</div>';
            commandCount = 0;
            document.getElementById('commandCount').textContent = '0';
        }
        
        // 顯示幫助
        function showHelp() {
            document.getElementById('helpModal').classList.add('active');
        }
        
        // 關閉幫助
        function closeHelp() {
            document.getElementById('helpModal').classList.remove('active');
        }
        
        // 顯示成功消息
        function showSuccess(message) {
            console.log(`✅ ${message}`);
            // 可以添加toast通知
        }
        
        // 顯示錯誤消息
        function showError(message) {
            console.error(`❌ ${message}`);
            // 可以添加toast通知
        }
        
        // 記錄日誌
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] ${message}`);
        }
        
        // 點擊模態框背景關閉
        document.getElementById('helpModal').addEventListener('click', (e) => {
            if (e.target.id === 'helpModal') {
                closeHelp();
            }
        });
        
        // ESC鍵關閉模態框
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeHelp();
            }
        });
    </script>
</body>
</html>


