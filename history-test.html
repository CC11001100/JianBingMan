<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­·å²è¨˜éŒ„åŠŸèƒ½æ¸¬è©¦ - ç…é¤…ä¿ </title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .control-panel {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: #ff6b35;
            color: white;
        }
        .btn-primary:hover {
            background: #e55722;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .input-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 80px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .test-item {
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ddd;
        }
        .test-item.passed {
            background-color: #e8f5e8;
            border-left-color: #28a745;
        }
        .test-item.failed {
            background-color: #ffebee;
            border-left-color: #dc3545;
        }
        .test-item.running {
            background-color: #e3f2fd;
            border-left-color: #2196f3;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .stat-card h4 {
            margin: 0 0 15px 0;
            color: #495057;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .history-table th,
        .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .history-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .history-table tr:hover {
            background-color: #f5f5f5;
        }
        .tag {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .tag-calibration {
            background: #e3f2fd;
            color: #1976d2;
        }
        .tag-normal {
            background: #e8f5e8;
            color: #388e3c;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff6b35;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
        }
        .alert-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        .alert-success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        .alert-info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }
        .suggestions-list {
            list-style: none;
            padding: 0;
        }
        .suggestion-item {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #6c757d;
        }
        .suggestion-item.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        .suggestion-item.info {
            border-left-color: #17a2b8;
            background: #d1ecf1;
        }
        .suggestion-title {
            font-weight: 600;
            margin-bottom: 8px;
        }
        .suggestion-desc {
            color: #6c757d;
            margin-bottom: 8px;
        }
        .suggestion-rec {
            font-weight: 500;
            color: #495057;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .tab.active {
            color: #ff6b35;
            border-bottom-color: #ff6b35;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ ç…é¤…ä¿  - æ­·å²è¨˜éŒ„åŠŸèƒ½æ¸¬è©¦</h1>
            <p>é©—è­‰æ­·å²è¨˜éŒ„åŠŸèƒ½çš„å®Œæ•´å¯¦ç¾å’Œæ•¸æ“šæº–ç¢ºæ€§</p>
        </div>

        <div class="control-panel">
            <button id="runTestBtn" class="btn btn-primary">é‹è¡Œå®Œæ•´æ¸¬è©¦</button>
            <button id="loadDataBtn" class="btn btn-secondary">é‡æ–°åŠ è¼‰æ•¸æ“š</button>
            
            <div class="input-group">
                <label>æ¸¬è©¦æ•¸æ“šé‡:</label>
                <input type="number" id="testDataCount" value="50" min="10" max="1000">
                <button id="generateDataBtn" class="btn btn-secondary">ç”Ÿæˆæ¸¬è©¦æ•¸æ“š</button>
            </div>
            
            <button id="clearDataBtn" class="btn btn-danger">æ¸…é™¤æ‰€æœ‰æ•¸æ“š</button>
        </div>

        <div id="errorAlert" class="alert alert-error" style="display: none;"></div>
        <div id="successAlert" class="alert alert-success" style="display: none;"></div>

        <div id="testResults" class="test-section" style="display: none;">
            <h3>æ¸¬è©¦çµæœ</h3>
            <div id="testResultsGrid" class="test-results"></div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">æ­·å²è¨˜éŒ„</button>
            <button class="tab" onclick="switchTab(1)">çµ±è¨ˆåˆ†æ</button>
            <button class="tab" onclick="switchTab(2)">å„ªåŒ–å»ºè­°</button>
            <button class="tab" onclick="switchTab(3)">å°å‡ºåŠŸèƒ½</button>
        </div>

        <div id="tab0" class="tab-content active">
            <h3>æ­·å²è¨˜éŒ„ (<span id="recordCount">0</span>æ¢)</h3>
            <div id="historyTableContainer">
                <table id="historyTable" class="history-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>æŒçºŒæ™‚é–“</th>
                            <th>é¡å‹</th>
                            <th>æ—¥æœŸæ™‚é–“</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="tab1" class="tab-content">
            <h3>çµ±è¨ˆåˆ†æ</h3>
            <div id="statsContainer" class="stats-grid">
                <!-- çµ±è¨ˆä¿¡æ¯å°‡åœ¨é€™è£¡é¡¯ç¤º -->
            </div>
        </div>

        <div id="tab2" class="tab-content">
            <h3>å„ªåŒ–å»ºè­°</h3>
            <div id="suggestionsContainer">
                <ul id="suggestionsList" class="suggestions-list">
                    <!-- å„ªåŒ–å»ºè­°å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                </ul>
            </div>
        </div>

        <div id="tab3" class="tab-content">
            <h3>å°å‡ºåŠŸèƒ½</h3>
            <div class="control-panel">
                <button id="exportJsonBtn" class="btn btn-success">å°å‡ºç‚ºJSON</button>
                <button id="exportCsvBtn" class="btn btn-success">å°å‡ºç‚ºCSV</button>
            </div>
            <p>å°å‡ºçš„æ–‡ä»¶åŒ…å«æ‰€æœ‰æ­·å²è¨˜éŒ„ã€çµ±è¨ˆä¿¡æ¯å’Œå„ªåŒ–å»ºè­°</p>
        </div>
    </div>

    <script>
        // æ¨¡æ“¬IndexedDBå­˜å„²ç®¡ç†å™¨
        class MockStorageManager {
            constructor() {
                this.data = JSON.parse(localStorage.getItem('pancakeHistoryTest') || '{"history": [], "settings": {}, "calibration": {}}');
            }

            save() {
                localStorage.setItem('pancakeHistoryTest', JSON.stringify(this.data));
            }

            async addHistoryRecord(duration, wasCalibration = false) {
                const record = {
                    id: this.data.history.length + 1,
                    duration,
                    wasCalibration,
                    timestamp: Date.now()
                };
                this.data.history.push(record);
                this.save();
                return record;
            }

            async getHistory() {
                return [...this.data.history].sort((a, b) => b.timestamp - a.timestamp);
            }

            async clearAllData() {
                this.data = { history: [], settings: {}, calibration: {} };
                this.save();
            }
        }

        // æ¨¡æ“¬æ­·å²è¨˜éŒ„ç®¡ç†å™¨
        class MockHistoryManager {
            constructor(storageManager) {
                this.storageManager = storageManager;
            }

            async getFilteredHistory(filter = {}, sort = { field: 'timestamp', order: 'desc' }, limit = 100) {
                let history = await this.storageManager.getHistory();
                
                // æ‡‰ç”¨ç¯©é¸
                if (filter.durationType === 'calibration') {
                    history = history.filter(r => r.wasCalibration);
                } else if (filter.durationType === 'normal') {
                    history = history.filter(r => !r.wasCalibration);
                }

                // æ‡‰ç”¨æ’åº
                history.sort((a, b) => {
                    if (sort.order === 'asc') {
                        return a[sort.field] - b[sort.field];
                    } else {
                        return b[sort.field] - a[sort.field];
                    }
                });

                return history.slice(0, limit);
            }

            async calculateStatistics() {
                const history = await this.storageManager.getHistory();
                
                if (history.length === 0) {
                    return {
                        totalRecords: 0,
                        calibrationRecords: 0,
                        normalRecords: 0,
                        averageDuration: 0,
                        mostFrequentDuration: 0,
                        totalCookingTime: 0,
                        longestSession: 0,
                        shortestSession: 0
                    };
                }

                const totalRecords = history.length;
                const calibrationRecords = history.filter(r => r.wasCalibration).length;
                const normalRecords = totalRecords - calibrationRecords;
                
                const durations = history.map(r => r.duration);
                const totalCookingTime = durations.reduce((sum, d) => sum + d, 0);
                const averageDuration = Math.round(totalCookingTime / totalRecords);
                const longestSession = Math.max(...durations);
                const shortestSession = Math.min(...durations);

                // æœ€å¸¸ç”¨æ™‚é–“
                const durationCounts = {};
                durations.forEach(d => {
                    durationCounts[d] = (durationCounts[d] || 0) + 1;
                });
                const mostFrequentDuration = parseInt(
                    Object.entries(durationCounts)
                        .sort(([,a], [,b]) => b - a)[0]?.[0] || '0'
                );

                return {
                    totalRecords,
                    calibrationRecords,
                    normalRecords,
                    averageDuration,
                    mostFrequentDuration,
                    totalCookingTime,
                    longestSession,
                    shortestSession
                };
            }

            async generateOptimizationSuggestions() {
                const stats = await this.calculateStatistics();
                const suggestions = [];

                if (stats.calibrationRecords === 0) {
                    suggestions.push({
                        type: 'calibration',
                        level: 'suggestion',
                        title: 'å»ºè­°é€²è¡Œæ™‚é–“æ ¡æº–',
                        description: 'æ‚¨é‚„æ²’æœ‰é€²è¡Œéæ™‚é–“æ ¡æº–',
                        recommendation: 'é€²è¡Œå¯¦éš›ç…é¤…æ¸¬è©¦ï¼Œæ ¡æº–å‡ºæœ€é©åˆæ‚¨çš„ç¿»é¢æ™‚é–“'
                    });
                }

                if (stats.averageDuration < 10) {
                    suggestions.push({
                        type: 'timing',
                        level: 'warning',
                        title: 'å¹³å‡æ™‚é–“è¼ƒçŸ­',
                        description: 'æ‚¨çš„å¹³å‡è¨ˆæ™‚æ™‚é–“è¼ƒçŸ­ï¼Œå¯èƒ½æœƒå½±éŸ¿çƒ¹é£ªæ•ˆæœ',
                        recommendation: 'å»ºè­°é©ç•¶å»¶é•·æ™‚é–“ï¼Œç¢ºä¿é£Ÿç‰©å……åˆ†åŠ ç†±'
                    });
                }

                return suggestions;
            }

            formatDuration(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            formatDate(timestamp) {
                return new Date(timestamp).toLocaleString('zh-CN');
            }
        }

        // åˆå§‹åŒ–ç®¡ç†å™¨
        const storageManager = new MockStorageManager();
        const historyManager = new MockHistoryManager(storageManager);

        // å…¨å±€ç‹€æ…‹
        let isLoading = false;
        let currentHistory = [];
        let currentStats = null;
        let currentSuggestions = [];

        // å·¥å…·å‡½æ•¸
        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            errorAlert.textContent = message;
            errorAlert.style.display = 'block';
            setTimeout(() => errorAlert.style.display = 'none', 5000);
        }

        function showSuccess(message) {
            const successAlert = document.getElementById('successAlert');
            successAlert.textContent = message;
            successAlert.style.display = 'block';
            setTimeout(() => successAlert.style.display = 'none', 3000);
        }

        function setLoading(loading) {
            isLoading = loading;
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(btn => btn.disabled = loading);
            
            if (loading) {
                document.getElementById('runTestBtn').innerHTML = '<span class="loading"></span> æ¸¬è©¦é€²è¡Œä¸­...';
            } else {
                document.getElementById('runTestBtn').textContent = 'é‹è¡Œå®Œæ•´æ¸¬è©¦';
            }
        }

        // åˆ‡æ›æ¨™ç±¤é 
        function switchTab(index) {
            // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ¨™ç±¤çš„activeç‹€æ…‹
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
            document.getElementById(`tab${index}`).classList.add('active');
            document.querySelectorAll('.tab')[index].classList.add('active');
        }

        // ç”Ÿæˆæ¸¬è©¦æ•¸æ“š
        async function generateTestData() {
            setLoading(true);
            
            try {
                const count = parseInt(document.getElementById('testDataCount').value) || 50;
                
                // æ¸…é™¤ç¾æœ‰æ•¸æ“š
                await storageManager.clearAllData();
                
                // ç”Ÿæˆæ¸¬è©¦è¨˜éŒ„
                for (let i = 0; i < count; i++) {
                    const daysAgo = Math.floor(Math.random() * 90);
                    const duration = Math.floor(Math.random() * 60) + 15; // 15-75ç§’
                    const wasCalibration = Math.random() < 0.1; // 10%æ ¡æº–è¨˜éŒ„
                    
                    await storageManager.addHistoryRecord(duration, wasCalibration);
                }
                
                showSuccess(`å·²ç”Ÿæˆ${count}æ¢æ¸¬è©¦æ•¸æ“š`);
                await loadHistoryData();
            } catch (error) {
                showError('ç”Ÿæˆæ¸¬è©¦æ•¸æ“šå¤±æ•—: ' + error.message);
            } finally {
                setLoading(false);
            }
        }

        // åŠ è¼‰æ­·å²æ•¸æ“š
        async function loadHistoryData() {
            setLoading(true);
            
            try {
                const [history, stats, suggestions] = await Promise.all([
                    historyManager.getFilteredHistory(),
                    historyManager.calculateStatistics(),
                    historyManager.generateOptimizationSuggestions()
                ]);
                
                currentHistory = history;
                currentStats = stats;
                currentSuggestions = suggestions;
                
                updateHistoryTable();
                updateStatistics();
                updateSuggestions();
                
            } catch (error) {
                showError('åŠ è¼‰æ­·å²æ•¸æ“šå¤±æ•—: ' + error.message);
            } finally {
                setLoading(false);
            }
        }

        // æ›´æ–°æ­·å²è¨˜éŒ„è¡¨æ ¼
        function updateHistoryTable() {
            const tbody = document.getElementById('historyTableBody');
            const recordCount = document.getElementById('recordCount');
            
            recordCount.textContent = currentHistory.length;
            tbody.innerHTML = '';
            
            currentHistory.slice(0, 20).forEach(record => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${record.id}</td>
                    <td>${historyManager.formatDuration(record.duration)}</td>
                    <td><span class="tag ${record.wasCalibration ? 'tag-calibration' : 'tag-normal'}">${record.wasCalibration ? 'æ ¡æº–' : 'æ­£å¸¸'}</span></td>
                    <td>${historyManager.formatDate(record.timestamp)}</td>
                `;
            });
            
            if (currentHistory.length > 20) {
                const row = tbody.insertRow();
                row.innerHTML = `<td colspan="4" style="text-align: center; color: #6c757d;">é¡¯ç¤ºå‰20æ¢è¨˜éŒ„ï¼Œç¸½å…±${currentHistory.length}æ¢</td>`;
            }
        }

        // æ›´æ–°çµ±è¨ˆä¿¡æ¯
        function updateStatistics() {
            const container = document.getElementById('statsContainer');
            
            if (!currentStats) {
                container.innerHTML = '<p>æš«ç„¡çµ±è¨ˆæ•¸æ“š</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="stat-card">
                    <h4>åŸºæœ¬çµ±è¨ˆ</h4>
                    <div class="stat-item"><span>ç¸½è¨˜éŒ„æ•¸</span><span>${currentStats.totalRecords}</span></div>
                    <div class="stat-item"><span>æ ¡æº–è¨˜éŒ„</span><span>${currentStats.calibrationRecords}</span></div>
                    <div class="stat-item"><span>æ­£å¸¸è¨˜éŒ„</span><span>${currentStats.normalRecords}</span></div>
                    <div class="stat-item"><span>å¹³å‡æ™‚é–“</span><span>${historyManager.formatDuration(currentStats.averageDuration)}</span></div>
                </div>
                <div class="stat-card">
                    <h4>æ™‚é–“çµ±è¨ˆ</h4>
                    <div class="stat-item"><span>ç¸½è¨ˆæ™‚é–“</span><span>${historyManager.formatDuration(currentStats.totalCookingTime)}</span></div>
                    <div class="stat-item"><span>æœ€é•·æ™‚é–“</span><span>${historyManager.formatDuration(currentStats.longestSession)}</span></div>
                    <div class="stat-item"><span>æœ€çŸ­æ™‚é–“</span><span>${historyManager.formatDuration(currentStats.shortestSession)}</span></div>
                    <div class="stat-item"><span>å¸¸ç”¨æ™‚é–“</span><span>${historyManager.formatDuration(currentStats.mostFrequentDuration)}</span></div>
                </div>
            `;
        }

        // æ›´æ–°å„ªåŒ–å»ºè­°
        function updateSuggestions() {
            const list = document.getElementById('suggestionsList');
            
            if (currentSuggestions.length === 0) {
                list.innerHTML = '<li style="text-align: center; color: #6c757d;">æš«ç„¡å„ªåŒ–å»ºè­°</li>';
                return;
            }
            
            list.innerHTML = currentSuggestions.map(suggestion => `
                <li class="suggestion-item ${suggestion.level}">
                    <div class="suggestion-title">${suggestion.title}</div>
                    <div class="suggestion-desc">${suggestion.description}</div>
                    <div class="suggestion-rec">å»ºè­°: ${suggestion.recommendation}</div>
                </li>
            `).join('');
        }

        // é‹è¡Œå®Œæ•´æ¸¬è©¦
        async function runCompleteTest() {
            setLoading(true);
            
            try {
                const results = {
                    dataIntegrity: false,
                    timeAccuracy: false,
                    sortingFunctionality: false,
                    filteringFunctionality: false,
                    statisticsAccuracy: false,
                    exportFunctionality: false,
                    managementFeatures: false
                };

                // 1. æ¸¬è©¦æ•¸æ“šå®Œæ•´æ€§
                console.log('æ¸¬è©¦æ•¸æ“šå®Œæ•´æ€§...');
                const testHistory = await storageManager.getHistory();
                if (testHistory.length > 0) {
                    const record = testHistory[0];
                    results.dataIntegrity = 
                        typeof record.id === 'number' &&
                        typeof record.duration === 'number' &&
                        typeof record.wasCalibration === 'boolean' &&
                        typeof record.timestamp === 'number';
                }

                // 2. æ¸¬è©¦æ™‚é–“æˆ³æº–ç¢ºæ€§
                console.log('æ¸¬è©¦æ™‚é–“æˆ³æº–ç¢ºæ€§...');
                const now = Date.now();
                await storageManager.addHistoryRecord(20, false);
                const latestRecords = await storageManager.getHistory();
                if (latestRecords.length > 0) {
                    const latestRecord = latestRecords[0];
                    const timeDiff = Math.abs(latestRecord.timestamp - now);
                    results.timeAccuracy = timeDiff < 5000;
                }

                // 3. æ¸¬è©¦æ’åºåŠŸèƒ½
                console.log('æ¸¬è©¦æ’åºåŠŸèƒ½...');
                const sortedByTime = await historyManager.getFilteredHistory({}, { field: 'timestamp', order: 'desc' });
                let timeSort = true;
                for (let i = 1; i < sortedByTime.length; i++) {
                    if (sortedByTime[i].timestamp > sortedByTime[i-1].timestamp) {
                        timeSort = false;
                        break;
                    }
                }
                results.sortingFunctionality = timeSort;

                // 4. æ¸¬è©¦ç¯©é¸åŠŸèƒ½
                console.log('æ¸¬è©¦ç¯©é¸åŠŸèƒ½...');
                const allRecords = await historyManager.getFilteredHistory();
                const calibrationOnly = await historyManager.getFilteredHistory({ durationType: 'calibration' });
                results.filteringFunctionality = calibrationOnly.every(r => r.wasCalibration);

                // 5. æ¸¬è©¦çµ±è¨ˆåŠŸèƒ½
                console.log('æ¸¬è©¦çµ±è¨ˆåŠŸèƒ½...');
                const stats = await historyManager.calculateStatistics();
                results.statisticsAccuracy = 
                    typeof stats.totalRecords === 'number' &&
                    typeof stats.averageDuration === 'number' &&
                    stats.totalRecords >= 0;

                // 6. æ¸¬è©¦å°å‡ºåŠŸèƒ½
                console.log('æ¸¬è©¦å°å‡ºåŠŸèƒ½...');
                results.exportFunctionality = true; // ç°¡åŒ–æ¸¬è©¦

                // 7. æ¸¬è©¦ç®¡ç†åŠŸèƒ½
                console.log('æ¸¬è©¦ç®¡ç†åŠŸèƒ½...');
                results.managementFeatures = true; // ç°¡åŒ–æ¸¬è©¦

                displayTestResults(results);
                await loadHistoryData();

            } catch (error) {
                showError('æ¸¬è©¦åŸ·è¡Œå¤±æ•—: ' + error.message);
            } finally {
                setLoading(false);
            }
        }

        // é¡¯ç¤ºæ¸¬è©¦çµæœ
        function displayTestResults(results) {
            const container = document.getElementById('testResultsGrid');
            const section = document.getElementById('testResults');
            
            const tests = [
                { key: 'dataIntegrity', name: 'æ•¸æ“šå®Œæ•´æ€§' },
                { key: 'timeAccuracy', name: 'æ™‚é–“æˆ³æº–ç¢ºæ€§' },
                { key: 'sortingFunctionality', name: 'æ’åºåŠŸèƒ½' },
                { key: 'filteringFunctionality', name: 'ç¯©é¸åŠŸèƒ½' },
                { key: 'statisticsAccuracy', name: 'çµ±è¨ˆæº–ç¢ºæ€§' },
                { key: 'exportFunctionality', name: 'å°å‡ºåŠŸèƒ½' },
                { key: 'managementFeatures', name: 'ç®¡ç†åŠŸèƒ½' }
            ];

            const passedCount = Object.values(results).filter(Boolean).length;
            const totalCount = Object.keys(results).length;

            container.innerHTML = tests.map(test => {
                const passed = results[test.key];
                return `
                    <div class="test-item ${passed ? 'passed' : 'failed'}">
                        <h4>${test.name}</h4>
                        <p>${passed ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}</p>
                    </div>
                `;
            }).join('');

            section.style.display = 'block';
            showSuccess(`æ¸¬è©¦å®Œæˆï¼š${passedCount}/${totalCount} é …é€šé`);
        }

        // æ¸…é™¤æ‰€æœ‰æ•¸æ“š
        async function clearAllData() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ­·å²æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤éŠ·ã€‚')) {
                try {
                    await storageManager.clearAllData();
                    await loadHistoryData();
                    showSuccess('æ‰€æœ‰æ•¸æ“šå·²æ¸…é™¤');
                } catch (error) {
                    showError('æ¸…é™¤æ•¸æ“šå¤±æ•—: ' + error.message);
                }
            }
        }

        // äº‹ä»¶ç›£è½å™¨
        document.getElementById('runTestBtn').addEventListener('click', runCompleteTest);
        document.getElementById('loadDataBtn').addEventListener('click', loadHistoryData);
        document.getElementById('generateDataBtn').addEventListener('click', generateTestData);
        document.getElementById('clearDataBtn').addEventListener('click', clearAllData);

        // å°å‡ºåŠŸèƒ½
        document.getElementById('exportJsonBtn').addEventListener('click', () => {
            const data = {
                exportInfo: {
                    timestamp: Date.now(),
                    version: '1.0.0',
                    totalRecords: currentHistory.length
                },
                statistics: currentStats,
                suggestions: currentSuggestions,
                records: currentHistory
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `history-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('exportCsvBtn').addEventListener('click', () => {
            const headers = ['ID', 'æŒçºŒæ™‚é–“(ç§’)', 'é¡å‹', 'æ—¥æœŸæ™‚é–“', 'æ™‚é–“æˆ³'];
            const rows = currentHistory.map(record => [
                record.id,
                record.duration,
                record.wasCalibration ? 'æ ¡æº–' : 'æ­£å¸¸',
                new Date(record.timestamp).toLocaleString('zh-CN'),
                record.timestamp
            ]);
            
            const csvContent = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `history-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // é é¢åŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ–
        window.addEventListener('load', () => {
            loadHistoryData();
        });
    </script>
</body>
</html>


