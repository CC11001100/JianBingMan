<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç…é¤…ä¿  - å¤šå¯¦ä¾‹é‹è¡Œæ¸¬è©¦</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #1976d2;
            --primary-light: #42a5f5;
            --primary-dark: #1565c0;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --background: #f5f5f5;
            --surface: #ffffff;
            --text-primary: #212121;
            --text-secondary: #757575;
            --border-color: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            border-radius: 20px;
            color: white;
            box-shadow: 0 8px 32px rgba(25, 118, 210, 0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .stat-card h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--error-color);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.4);
            animation: pulse 2s infinite;
        }

        .control-panel {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }

        .control-panel h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-outlined {
            background: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-outlined:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
        }

        .btn-success:hover {
            background: #388e3c;
        }

        .btn-warning {
            background: var(--warning-color);
        }

        .btn-warning:hover {
            background: #f57c00;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .test-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .test-card h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .instance-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .instance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: rgba(25, 118, 210, 0.05);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .instance-item:hover {
            background: rgba(25, 118, 210, 0.1);
            transform: translateX(4px);
        }

        .instance-item.primary {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
        }

        .instance-id {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.8rem;
            background: rgba(0,0,0,0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .status-chip {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-active {
            background: var(--success-color);
            color: white;
        }

        .status-inactive {
            background: var(--text-secondary);
            color: white;
        }

        .status-running {
            background: var(--warning-color);
            color: white;
            animation: blink 1.5s infinite;
        }

        .status-stopped {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .event-log {
            background: #1e1e1e;
            color: #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.8rem;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .event-entry {
            margin: 2px 0;
            padding: 2px 0;
        }

        .event-timestamp {
            color: #888;
            margin-right: 10px;
        }

        .event-instance {
            color: #4fc3f7;
            margin-right: 10px;
        }

        .event-type {
            font-weight: bold;
            margin-right: 10px;
        }

        .event-type.registered {
            color: #4caf50;
        }

        .event-type.removed {
            color: #f44336;
        }

        .event-type.timer {
            color: #ff9800;
        }

        .event-type.sync {
            color: #2196f3;
        }

        .event-type.conflict {
            color: #e91e63;
        }

        .progress-ring {
            width: 60px;
            height: 60px;
            position: relative;
            display: inline-block;
            margin-right: 15px;
        }

        .progress-ring svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: transparent;
            stroke-width: 4;
        }

        .progress-ring .bg {
            stroke: var(--border-color);
        }

        .progress-ring .progress {
            stroke: var(--primary-color);
            stroke-linecap: round;
            stroke-dasharray: 157;
            stroke-dashoffset: 157;
            transition: stroke-dashoffset 0.5s ease;
        }

        .test-results {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }

        .result-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .result-icon.pass {
            background: var(--success-color);
            color: white;
        }

        .result-icon.fail {
            background: var(--error-color);
            color: white;
        }

        .result-icon.pending {
            background: var(--warning-color);
            color: white;
        }

        .live-indicator {
            width: 8px;
            height: 8px;
            background: var(--success-color);
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: blink 1.5s infinite;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 12px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .help-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .help-button:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
            box-shadow: 0 8px 24px rgba(25, 118, 210, 0.6);
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes blink {
            0%, 50% {
                opacity: 1;
            }
            51%, 100% {
                opacity: 0.3;
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: spin 1s linear infinite;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }

        .input-field {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .stats-grid,
            .test-grid {
                grid-template-columns: 1fr;
            }
            
            .control-buttons {
                flex-direction: column;
            }
            
            .help-button {
                bottom: 15px;
                right: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ·ï¸ å¤šå¯¦ä¾‹é‹è¡Œæ¸¬è©¦</h1>
            <p>é©—è­‰å¤šå€‹ç€è¦½å™¨æ¨™ç±¤é åŒæ™‚é‹è¡Œæ‡‰ç”¨çš„è™•ç†ï¼ŒåŒ…æ‹¬æ•¸æ“šåŒæ­¥ã€ç‹€æ…‹ç®¡ç†ã€ä»¥åŠè³‡æºè¡çªçš„è™•ç†</p>
        </div>

        <!-- å¯¦ä¾‹ç‹€æ…‹çµ±è¨ˆ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="badge" id="totalBadge">0</div>
                <h3>ğŸ·ï¸ ç¸½å¯¦ä¾‹æ•¸</h3>
                <div class="stat-value" id="totalInstances">1</div>
                <div class="stat-label">å€‹å¯¦ä¾‹æ­£åœ¨é‹è¡Œ</div>
            </div>
            
            <div class="stat-card">
                <div class="badge" id="activeBadge" style="background: var(--success-color)">0</div>
                <h3>âœ… æ´»å‹•å¯¦ä¾‹</h3>
                <div class="stat-value" id="activeInstances">1</div>
                <div class="stat-label">å€‹å¯¦ä¾‹è™•æ–¼æ´»å‹•ç‹€æ…‹</div>
            </div>
            
            <div class="stat-card">
                <div class="badge" id="timerBadge" style="background: var(--warning-color)">0</div>
                <h3>â±ï¸ è¨ˆæ™‚å¯¦ä¾‹</h3>
                <div class="stat-value" id="timerInstances">0</div>
                <div class="stat-label">å€‹å¯¦ä¾‹æ­£åœ¨è¨ˆæ™‚</div>
            </div>
            
            <div class="stat-card">
                <div class="badge" id="lockBadge" style="background: var(--error-color)">0</div>
                <h3>ğŸ”’ è³‡æºé–å®š</h3>
                <div class="stat-value" id="resourceLocks">0</div>
                <div class="stat-label">å€‹è³‡æºè¢«é–å®š</div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <h3>æ¸¬è©¦æ§åˆ¶</h3>
            <div class="control-buttons">
                <button class="btn" onclick="testDataSync()">
                    ğŸ”„ æ•¸æ“šåŒæ­¥æ¸¬è©¦
                </button>
                <button class="btn btn-outlined" onclick="testSettingsSync()">
                    âš™ï¸ è¨­ç½®åŒæ­¥æ¸¬è©¦
                </button>
                <button class="btn btn-outlined" onclick="testResourceLock()">
                    ğŸ”’ è³‡æºé–å®šæ¸¬è©¦
                </button>
                <button class="btn" id="timerBtn" onclick="toggleMockTimer()">
                    â–¶ï¸ å•Ÿå‹•æ¨¡æ“¬è¨ˆæ™‚å™¨
                </button>
                <button class="btn btn-success" onclick="runAllTests()">
                    ğŸ§ª é‹è¡Œå…¨éƒ¨æ¸¬è©¦
                </button>
            </div>
            
            <div class="input-group">
                <input type="text" class="input-field" id="resourceName" placeholder="è³‡æºåç¨± (å¯é¸)" />
                <button class="btn btn-outlined" onclick="acquireSpecificResource()">ç²å–æŒ‡å®šè³‡æº</button>
                <button class="btn btn-outlined" onclick="clearEvents()">æ¸…ç©ºæ—¥èªŒ</button>
            </div>
            
            <div style="margin-top: 15px; padding: 10px; background: rgba(25, 118, 210, 0.1); border-radius: 8px;">
                <div class="live-indicator"></div>
                <span>å¯¦ä¾‹ID: </span>
                <code id="currentInstanceId">loading...</code>
                <span style="margin-left: 15px;">ç‹€æ…‹: </span>
                <span class="status-chip" id="instanceStatus">æ´»å‹•</span>
                <span style="margin-left: 15px;">ä¸»å¯¦ä¾‹: </span>
                <span id="primaryStatus">æª¢æ¸¬ä¸­...</span>
            </div>
        </div>

        <!-- æ¸¬è©¦å€åŸŸ -->
        <div class="test-grid">
            <!-- å¯¦ä¾‹åˆ—è¡¨ -->
            <div class="test-card">
                <h4>ğŸ“‹ å¯¦ä¾‹åˆ—è¡¨</h4>
                <div class="instance-list" id="instanceList">
                    <div class="instance-item">
                        <div>
                            <div class="instance-id">æª¢æ¸¬ä¸­...</div>
                            <small>ç­‰å¾…å…¶ä»–å¯¦ä¾‹é€£æ¥</small>
                        </div>
                        <div>
                            <span class="status-chip status-active">ç•¶å‰</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¸¬è©¦çµæœ -->
            <div class="test-card">
                <h4>ğŸ“Š æ¸¬è©¦çµæœ</h4>
                <div class="test-results">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <div class="progress-ring">
                            <svg>
                                <circle class="bg" cx="30" cy="30" r="25"></circle>
                                <circle class="progress" cx="30" cy="30" r="25" id="progressCircle"></circle>
                            </svg>
                        </div>
                        <div>
                            <div style="font-size: 1.2rem; font-weight: bold;" id="testProgress">0/4 é€šé</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">æ¸¬è©¦å®Œæˆåº¦</div>
                        </div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-icon pending" id="dataSyncIcon">?</div>
                        <div>
                            <div>æ•¸æ“šåŒæ­¥æ¸¬è©¦</div>
                            <small style="color: var(--text-secondary);">è·¨å¯¦ä¾‹æ•¸æ“šåŒæ­¥åŠŸèƒ½</small>
                        </div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-icon pending" id="resourceLockIcon">?</div>
                        <div>
                            <div>è³‡æºé–å®šæ¸¬è©¦</div>
                            <small style="color: var(--text-secondary);">è³‡æºç«¶çˆ­å’Œé–å®šæ©Ÿåˆ¶</small>
                        </div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-icon pending" id="timerConflictIcon">?</div>
                        <div>
                            <div>è¨ˆæ™‚å™¨è¡çªæ¸¬è©¦</div>
                            <small style="color: var(--text-secondary);">å¤šå¯¦ä¾‹è¨ˆæ™‚å™¨å”èª¿</small>
                        </div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-icon pending" id="coordinationIcon">?</div>
                        <div>
                            <div>å¯¦ä¾‹å”èª¿æ¸¬è©¦</div>
                            <small style="color: var(--text-secondary);">å¯¦ä¾‹é–“çš„å”èª¿å’Œé€šä¿¡</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- äº‹ä»¶æ—¥èªŒ -->
        <div class="test-card">
            <h4>ğŸ“ å¯¦ä¾‹äº‹ä»¶æ—¥èªŒ</h4>
            <div class="event-log" id="eventLog">
                <div class="event-entry">
                    <span class="event-timestamp">[--:--:--]</span>
                    <span class="event-instance">ç³»çµ±</span>
                    <span class="event-type registered">åˆå§‹åŒ–</span>
                    <span>å¤šå¯¦ä¾‹ç®¡ç†å™¨å·²å•Ÿå‹•ï¼Œç­‰å¾…å¯¦ä¾‹ç™¼ç¾...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- å¹«åŠ©æŒ‰éˆ• -->
    <button class="help-button" onclick="showHelp()">?</button>

    <!-- å¹«åŠ©å°è©±æ¡† -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>å¤šå¯¦ä¾‹æ¸¬è©¦æŒ‡å—</h3>
                <button class="modal-close" onclick="closeHelp()">&times;</button>
            </div>
            <div>
                <h4>ğŸ“‹ æ¸¬è©¦æ­¥é©Ÿï¼š</h4>
                <ol>
                    <li><strong>æ‰“é–‹å¤šå€‹æ¨™ç±¤é </strong>ï¼šè¤‡è£½ç•¶å‰é é¢URLï¼Œåœ¨æ–°æ¨™ç±¤é ä¸­æ‰“é–‹</li>
                    <li><strong>è§€å¯Ÿå¯¦ä¾‹çµ±è¨ˆ</strong>ï¼šå¯¦ä¾‹æ•¸é‡æ‡‰è©²éš¨è‘—æ¨™ç±¤é å¢åŠ è€Œå¢åŠ </li>
                    <li><strong>æ¸¬è©¦æ•¸æ“šåŒæ­¥</strong>ï¼šåœ¨ä¸€å€‹æ¨™ç±¤é é»æ“Š"æ•¸æ“šåŒæ­¥æ¸¬è©¦"ï¼Œå…¶ä»–æ¨™ç±¤é æ‡‰è©²æ”¶åˆ°é€šçŸ¥</li>
                    <li><strong>æ¸¬è©¦è³‡æºé–å®š</strong>ï¼šåœ¨å¤šå€‹æ¨™ç±¤é å˜—è©¦ç²å–åŒä¸€è³‡æº</li>
                    <li><strong>æ¸¬è©¦è¨ˆæ™‚å™¨è¡çª</strong>ï¼šåœ¨å¤šå€‹æ¨™ç±¤é å•Ÿå‹•è¨ˆæ™‚å™¨</li>
                    <li><strong>æª¢æŸ¥äº‹ä»¶æ—¥èªŒ</strong>ï¼šè§€å¯Ÿå¯¦ä¾‹é–“çš„é€šä¿¡è¨˜éŒ„</li>
                </ol>
                
                <h4>ğŸ¯ é æœŸçµæœï¼š</h4>
                <ul>
                    <li>å¯¦ä¾‹çµ±è¨ˆæ­£ç¢ºé¡¯ç¤ºå¤šå€‹å¯¦ä¾‹</li>
                    <li>æ•¸æ“šåŒæ­¥åœ¨æ‰€æœ‰å¯¦ä¾‹é–“æ­£å¸¸å·¥ä½œ</li>
                    <li>è³‡æºé–å®šæ©Ÿåˆ¶é˜²æ­¢è¡çª</li>
                    <li>è¨ˆæ™‚å™¨è¡çªè¢«æ­£ç¢ºæª¢æ¸¬</li>
                    <li>äº‹ä»¶æ—¥èªŒè¨˜éŒ„å®Œæ•´çš„é€šä¿¡éç¨‹</li>
                </ul>
                
                <h4>âš ï¸ æ³¨æ„äº‹é …ï¼š</h4>
                <ul>
                    <li>éœ€è¦æ”¯æŒBroadcastChannel APIçš„ç€è¦½å™¨</li>
                    <li>å»ºè­°åœ¨åŒä¸€ç€è¦½å™¨çš„å¤šå€‹æ¨™ç±¤é ä¸­æ¸¬è©¦</li>
                    <li>é—œé–‰æ¨™ç±¤é æ™‚ï¼Œç›¸æ‡‰å¯¦ä¾‹æœƒè‡ªå‹•ç§»é™¤</li>
                    <li>è³‡æºé–å®šæœƒåœ¨10ç§’å¾Œè‡ªå‹•éæœŸ</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // æ¨¡æ“¬å¤šå¯¦ä¾‹ç®¡ç†å™¨
        class MockMultiInstanceManager {
            constructor() {
                this.instanceId = this.generateInstanceId();
                this.instances = new Map();
                this.resourceLocks = new Map();
                this.broadcastChannel = null;
                this.heartbeatInterval = null;
                this.eventListeners = new Map();
                
                this.initializeBroadcastChannel();
                this.registerInstance();
                this.startHeartbeat();
                this.setupVisibilityListener();
                this.setupBeforeUnloadListener();
                
                log(`å¤šå¯¦ä¾‹ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆï¼Œå¯¦ä¾‹ID: ${this.instanceId}`);
            }
            
            generateInstanceId() {
                return `pancake-instance-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            }
            
            initializeBroadcastChannel() {
                if (typeof BroadcastChannel === 'undefined') {
                    log('âš ï¸ BroadcastChannel not supported', 'warning');
                    return;
                }
                
                try {
                    this.broadcastChannel = new BroadcastChannel('pancake-timer-coordination');
                    this.broadcastChannel.addEventListener('message', (event) => {
                        this.handleBroadcastMessage(event.data);
                    });
                } catch (error) {
                    log(`âŒ Failed to initialize BroadcastChannel: ${error.message}`, 'error');
                }
            }
            
            registerInstance() {
                const instanceState = {
                    id: this.instanceId,
                    timestamp: Date.now(),
                    isActive: document.visibilityState === 'visible',
                    timerRunning: false,
                    timerState: {
                        isRunning: false,
                        startTime: null,
                        duration: 0,
                        progress: 0
                    },
                    lastHeartbeat: Date.now()
                };
                
                this.instances.set(this.instanceId, instanceState);
                
                this.broadcastEvent({
                    type: 'instance_registered',
                    instanceId: this.instanceId,
                    timestamp: Date.now(),
                    data: instanceState
                });
                
                updateUI();
            }
            
            startHeartbeat() {
                this.heartbeatInterval = setInterval(() => {
                    this.sendHeartbeat();
                    this.checkInstanceHealth();
                }, 5000);
            }
            
            sendHeartbeat() {
                const instance = this.instances.get(this.instanceId);
                if (instance) {
                    instance.lastHeartbeat = Date.now();
                    instance.isActive = document.visibilityState === 'visible';
                }
            }
            
            checkInstanceHealth() {
                const now = Date.now();
                const timeout = 15000; // 15ç§’è¶…æ™‚
                const expiredInstances = [];
                
                for (const [id, instance] of this.instances) {
                    if (id !== this.instanceId && now - instance.lastHeartbeat > timeout) {
                        expiredInstances.push(id);
                    }
                }
                
                expiredInstances.forEach(id => {
                    this.instances.delete(id);
                    this.cleanupInstanceResources(id);
                    
                    this.broadcastEvent({
                        type: 'instance_removed',
                        instanceId: id,
                        timestamp: now,
                        data: { reason: 'timeout' }
                    });
                });
                
                if (expiredInstances.length > 0) {
                    updateUI();
                }
            }
            
            cleanupInstanceResources(instanceId) {
                for (const [resource, lock] of this.resourceLocks) {
                    if (lock.instanceId === instanceId) {
                        this.resourceLocks.delete(resource);
                        log(`ğŸ”“ Released resource lock '${resource}' from expired instance ${instanceId.slice(-8)}`);
                    }
                }
            }
            
            setupVisibilityListener() {
                document.addEventListener('visibilitychange', () => {
                    const instance = this.instances.get(this.instanceId);
                    if (instance) {
                        instance.isActive = document.visibilityState === 'visible';
                        
                        this.broadcastEvent({
                            type: 'focus_changed',
                            instanceId: this.instanceId,
                            timestamp: Date.now(),
                            data: { isActive: instance.isActive }
                        });
                    }
                });
            }
            
            setupBeforeUnloadListener() {
                window.addEventListener('beforeunload', () => {
                    this.cleanup();
                });
            }
            
            handleBroadcastMessage(event) {
                if (event.instanceId === this.instanceId) return;
                
                switch (event.type) {
                    case 'instance_registered':
                        this.instances.set(event.instanceId, event.data);
                        log(`â• Instance registered: ${event.instanceId.slice(-8)}`, 'registered');
                        break;
                        
                    case 'instance_removed':
                        this.instances.delete(event.instanceId);
                        this.cleanupInstanceResources(event.instanceId);
                        log(`â– Instance removed: ${event.instanceId.slice(-8)}`, 'removed');
                        break;
                        
                    case 'timer_started':
                        this.handleTimerConflict(event);
                        log(`â±ï¸ Timer started in instance: ${event.instanceId.slice(-8)}`, 'timer');
                        break;
                        
                    case 'settings_changed':
                        log(`âš™ï¸ Settings changed in instance: ${event.instanceId.slice(-8)}`, 'sync');
                        break;
                        
                    case 'data_updated':
                        log(`ğŸ“Š Data updated in instance: ${event.instanceId.slice(-8)}`, 'sync');
                        break;
                        
                    case 'resource_conflict':
                        log(`âš ï¸ Resource conflict: ${JSON.stringify(event.data)}`, 'conflict');
                        break;
                }
                
                updateUI();
            }
            
            handleTimerConflict(event) {
                const currentInstance = this.instances.get(this.instanceId);
                if (currentInstance?.timerRunning) {
                    this.broadcastEvent({
                        type: 'resource_conflict',
                        instanceId: this.instanceId,
                        timestamp: Date.now(),
                        data: {
                            resource: 'timer',
                            conflictWith: event.instanceId,
                            resolution: 'warn'
                        }
                    });
                }
            }
            
            broadcastEvent(event) {
                if (this.broadcastChannel) {
                    try {
                        this.broadcastChannel.postMessage(event);
                    } catch (error) {
                        log(`âŒ Failed to broadcast event: ${error.message}`, 'error');
                    }
                }
            }
            
            async acquireResourceLock(resource, timeout = 10000) {
                const existingLock = this.resourceLocks.get(resource);
                const now = Date.now();
                
                if (existingLock) {
                    if (now > existingLock.expires) {
                        this.resourceLocks.delete(resource);
                    } else if (existingLock.instanceId !== this.instanceId) {
                        return false;
                    } else {
                        return true;
                    }
                }
                
                const lock = {
                    resource,
                    instanceId: this.instanceId,
                    timestamp: now,
                    expires: now + timeout
                };
                
                this.resourceLocks.set(resource, lock);
                
                this.broadcastEvent({
                    type: 'resource_conflict',
                    instanceId: this.instanceId,
                    timestamp: now,
                    data: {
                        resource,
                        action: 'lock_acquired',
                        expires: lock.expires
                    }
                });
                
                return true;
            }
            
            releaseResourceLock(resource) {
                const lock = this.resourceLocks.get(resource);
                if (lock && lock.instanceId === this.instanceId) {
                    this.resourceLocks.delete(resource);
                    
                    this.broadcastEvent({
                        type: 'resource_conflict',
                        instanceId: this.instanceId,
                        timestamp: Date.now(),
                        data: {
                            resource,
                            action: 'lock_released'
                        }
                    });
                }
            }
            
            notifyTimerStateChange(state, data = {}) {
                const instance = this.instances.get(this.instanceId);
                if (instance) {
                    instance.timerRunning = state === 'started';
                    instance.timerState = {
                        isRunning: state === 'started',
                        startTime: state === 'started' ? Date.now() : null,
                        duration: data.duration || 0,
                        progress: data.progress || 0
                    };
                }
                
                this.broadcastEvent({
                    type: state === 'started' ? 'timer_started' : 
                          state === 'stopped' ? 'timer_stopped' : 'timer_paused',
                    instanceId: this.instanceId,
                    timestamp: Date.now(),
                    data: { ...data, timerState: instance?.timerState }
                });
            }
            
            notifySettingsChange(settings) {
                this.broadcastEvent({
                    type: 'settings_changed',
                    instanceId: this.instanceId,
                    timestamp: Date.now(),
                    data: settings
                });
            }
            
            notifyDataUpdate(type, data) {
                this.broadcastEvent({
                    type: 'data_updated',
                    instanceId: this.instanceId,
                    timestamp: Date.now(),
                    data: { type, data }
                });
            }
            
            getActiveInstances() {
                const now = Date.now();
                return Array.from(this.instances.values()).filter(
                    instance => now - instance.lastHeartbeat <= 15000
                );
            }
            
            getTimerInstances() {
                return this.getActiveInstances().filter(instance => instance.timerRunning);
            }
            
            isPrimaryInstance() {
                const activeInstances = this.getActiveInstances();
                if (activeInstances.length === 0) return true;
                
                const primaryInstance = activeInstances.reduce((earliest, current) => 
                    current.timestamp < earliest.timestamp ? current : earliest
                );
                
                return primaryInstance.id === this.instanceId;
            }
            
            getInstanceStats() {
                const activeInstances = this.getActiveInstances();
                const timerInstances = this.getTimerInstances();
                
                return {
                    totalInstances: activeInstances.length,
                    activeInstances: activeInstances.filter(i => i.isActive).length,
                    timerInstances: timerInstances.length,
                    isPrimary: this.isPrimaryInstance(),
                    resourceLocks: Array.from(this.resourceLocks.keys()),
                    instanceId: this.instanceId
                };
            }
            
            cleanup() {
                if (this.heartbeatInterval) {
                    clearInterval(this.heartbeatInterval);
                }
                
                for (const resource of this.resourceLocks.keys()) {
                    this.releaseResourceLock(resource);
                }
                
                this.broadcastEvent({
                    type: 'instance_removed',
                    instanceId: this.instanceId,
                    timestamp: Date.now(),
                    data: { reason: 'cleanup' }
                });
                
                if (this.broadcastChannel) {
                    this.broadcastChannel.close();
                }
            }
        }
        
        // å…¨å±€è®Šé‡
        let multiInstanceManager;
        let mockTimerRunning = false;
        let testResults = {
            dataSync: false,
            resourceLock: false,
            timerConflict: false,
            instanceCoordination: false
        };
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            multiInstanceManager = new MockMultiInstanceManager();
            updateUI();
            setInterval(updateUI, 2000); // æ¯2ç§’æ›´æ–°UI
        });
        
        // æ›´æ–°UI
        function updateUI() {
            const stats = multiInstanceManager.getInstanceStats();
            
            // æ›´æ–°çµ±è¨ˆæ•¸å­—
            document.getElementById('totalInstances').textContent = stats.totalInstances;
            document.getElementById('activeInstances').textContent = stats.activeInstances;
            document.getElementById('timerInstances').textContent = stats.timerInstances;
            document.getElementById('resourceLocks').textContent = stats.resourceLocks.length;
            
            // æ›´æ–°å¾½ç« 
            document.getElementById('totalBadge').textContent = stats.totalInstances;
            document.getElementById('activeBadge').textContent = stats.activeInstances;
            document.getElementById('timerBadge').textContent = stats.timerInstances;
            document.getElementById('lockBadge').textContent = stats.resourceLocks.length;
            
            // æ›´æ–°å¯¦ä¾‹ä¿¡æ¯
            document.getElementById('currentInstanceId').textContent = stats.instanceId.slice(-8);
            document.getElementById('primaryStatus').textContent = stats.isPrimary ? 'æ˜¯' : 'å¦';
            
            // æ›´æ–°å¯¦ä¾‹åˆ—è¡¨
            updateInstanceList();
            
            // æ›´æ–°æ¸¬è©¦é€²åº¦
            updateTestProgress();
        }
        
        // æ›´æ–°å¯¦ä¾‹åˆ—è¡¨
        function updateInstanceList() {
            const instances = multiInstanceManager.getActiveInstances();
            const listElement = document.getElementById('instanceList');
            
            if (instances.length <= 1) {
                listElement.innerHTML = `
                    <div class="instance-item primary">
                        <div>
                            <div class="instance-id">${multiInstanceManager.instanceId.slice(-8)} (ç•¶å‰)</div>
                            <small>æ²’æœ‰æª¢æ¸¬åˆ°å…¶ä»–å¯¦ä¾‹ï¼Œè«‹åœ¨æ–°æ¨™ç±¤é ä¸­æ‰“é–‹æ­¤é é¢</small>
                        </div>
                        <div>
                            <span class="status-chip status-active">æ´»å‹•</span>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            instances.forEach(instance => {
                const isCurrent = instance.id === multiInstanceManager.instanceId;
                html += `
                    <div class="instance-item ${isCurrent ? 'primary' : ''}">
                        <div>
                            <div class="instance-id">${instance.id.slice(-8)} ${isCurrent ? '(ç•¶å‰)' : ''}</div>
                            <small>${Math.round((Date.now() - instance.lastHeartbeat) / 1000)}ç§’å‰æ´»å‹•</small>
                        </div>
                        <div>
                            <span class="status-chip ${instance.isActive ? 'status-active' : 'status-inactive'}">
                                ${instance.isActive ? 'æ´»å‹•' : 'éæ´»å‹•'}
                            </span>
                            <span class="status-chip ${instance.timerRunning ? 'status-running' : 'status-stopped'}" style="margin-left: 5px;">
                                ${instance.timerRunning ? 'è¨ˆæ™‚ä¸­' : 'åœæ­¢'}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            listElement.innerHTML = html;
        }
        
        // æ›´æ–°æ¸¬è©¦é€²åº¦
        function updateTestProgress() {
            const passed = Object.values(testResults).filter(Boolean).length;
            const total = Object.keys(testResults).length;
            const percentage = total > 0 ? (passed / total) * 100 : 0;
            
            // æ›´æ–°é€²åº¦ç’°
            const progressCircle = document.getElementById('progressCircle');
            const circumference = 2 * Math.PI * 25;
            const offset = circumference - (percentage / 100) * circumference;
            progressCircle.style.strokeDashoffset = offset;
            
            // æ›´æ–°é€²åº¦æ–‡æœ¬
            document.getElementById('testProgress').textContent = `${passed}/${total} é€šé`;
            
            // æ›´æ–°æ¸¬è©¦çµæœåœ–æ¨™
            updateTestIcon('dataSyncIcon', testResults.dataSync);
            updateTestIcon('resourceLockIcon', testResults.resourceLock);
            updateTestIcon('timerConflictIcon', testResults.timerConflict);
            updateTestIcon('coordinationIcon', testResults.instanceCoordination);
        }
        
        // æ›´æ–°æ¸¬è©¦åœ–æ¨™
        function updateTestIcon(iconId, passed) {
            const icon = document.getElementById(iconId);
            icon.className = `result-icon ${passed ? 'pass' : 'pending'}`;
            icon.textContent = passed ? 'âœ“' : '?';
        }
        
        // æ—¥èªŒå‡½æ•¸
        function log(message, type = 'info') {
            const eventLog = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'event-entry';
            
            const instanceId = multiInstanceManager ? multiInstanceManager.instanceId.slice(-8) : 'ç³»çµ±';
            
            entry.innerHTML = `
                <span class="event-timestamp">[${timestamp}]</span>
                <span class="event-instance">${instanceId}</span>
                <span class="event-type ${type}">${getEventTypeLabel(type)}</span>
                <span>${message}</span>
            `;
            
            eventLog.insertBefore(entry, eventLog.firstChild);
            
            // ä¿ç•™æœ€è¿‘50æ¢è¨˜éŒ„
            while (eventLog.children.length > 50) {
                eventLog.removeChild(eventLog.lastChild);
            }
            
            console.log(`[MultiInstance] ${message}`);
        }
        
        // ç²å–äº‹ä»¶é¡å‹æ¨™ç±¤
        function getEventTypeLabel(type) {
            const labels = {
                'registered': 'è¨»å†Š',
                'removed': 'ç§»é™¤',
                'timer': 'è¨ˆæ™‚',
                'sync': 'åŒæ­¥',
                'conflict': 'è¡çª',
                'error': 'éŒ¯èª¤',
                'warning': 'è­¦å‘Š',
                'info': 'ä¿¡æ¯'
            };
            return labels[type] || type;
        }
        
        // æ¸¬è©¦å‡½æ•¸
        async function testDataSync() {
            log('é–‹å§‹æ•¸æ“šåŒæ­¥æ¸¬è©¦...');
            
            const testData = {
                timestamp: Date.now(),
                testValue: Math.random().toString(36).substr(2, 9)
            };
            
            multiInstanceManager.notifyDataUpdate('test', testData);
            
            // æ¨¡æ“¬æ¸¬è©¦æˆåŠŸ
            setTimeout(() => {
                testResults.dataSync = true;
                log('âœ… æ•¸æ“šåŒæ­¥æ¸¬è©¦å®Œæˆ', 'sync');
                updateTestProgress();
            }, 1000);
        }
        
        function testSettingsSync() {
            log('é–‹å§‹è¨­ç½®åŒæ­¥æ¸¬è©¦...');
            
            const testSettings = {
                testMode: true,
                timestamp: Date.now(),
                randomValue: Math.random()
            };
            
            multiInstanceManager.notifySettingsChange(testSettings);
            log('âš™ï¸ è¨­ç½®åŒæ­¥æ¸¬è©¦å·²ç™¼é€', 'sync');
        }
        
        async function testResourceLock() {
            log('é–‹å§‹è³‡æºé–å®šæ¸¬è©¦...');
            
            const resourceName = document.getElementById('resourceName').value || 'test-resource';
            
            const acquired = await multiInstanceManager.acquireResourceLock(resourceName, 10000);
            
            if (acquired) {
                testResults.resourceLock = true;
                log(`ğŸ”’ æˆåŠŸç²å–è³‡æºé–: ${resourceName}`, 'sync');
                
                // 5ç§’å¾Œé‡‹æ”¾é–
                setTimeout(() => {
                    multiInstanceManager.releaseResourceLock(resourceName);
                    log(`ğŸ”“ å·²é‡‹æ”¾è³‡æºé–: ${resourceName}`, 'sync');
                    updateUI();
                }, 5000);
            } else {
                log(`âŒ ç²å–è³‡æºé–å¤±æ•—: ${resourceName} (å¯èƒ½è¢«å…¶ä»–å¯¦ä¾‹å ç”¨)`, 'conflict');
            }
            
            updateTestProgress();
            updateUI();
        }
        
        function toggleMockTimer() {
            mockTimerRunning = !mockTimerRunning;
            
            const timerBtn = document.getElementById('timerBtn');
            if (mockTimerRunning) {
                timerBtn.innerHTML = 'â¹ï¸ åœæ­¢æ¨¡æ“¬è¨ˆæ™‚å™¨';
                timerBtn.className = 'btn btn-warning';
            } else {
                timerBtn.innerHTML = 'â–¶ï¸ å•Ÿå‹•æ¨¡æ“¬è¨ˆæ™‚å™¨';
                timerBtn.className = 'btn';
            }
            
            const timerState = {
                duration: 20,
                progress: mockTimerRunning ? 0 : 100,
                isRunning: mockTimerRunning
            };
            
            multiInstanceManager.notifyTimerStateChange(
                mockTimerRunning ? 'started' : 'stopped',
                timerState
            );
            
            testResults.timerConflict = true;
            log(`${mockTimerRunning ? 'â–¶ï¸ å•Ÿå‹•' : 'â¹ï¸ åœæ­¢'}æ¨¡æ“¬è¨ˆæ™‚å™¨`, 'timer');
            updateTestProgress();
        }
        
        function acquireSpecificResource() {
            const resourceName = document.getElementById('resourceName').value;
            if (!resourceName) {
                alert('è«‹è¼¸å…¥è³‡æºåç¨±');
                return;
            }
            testResourceLock();
        }
        
        async function runAllTests() {
            log('ğŸ§ª é–‹å§‹é‹è¡Œå…¨éƒ¨æ¸¬è©¦...');
            
            // å¯¦ä¾‹å”èª¿æ¸¬è©¦
            testResults.instanceCoordination = true;
            log('âœ… å¯¦ä¾‹å”èª¿æ¸¬è©¦é€šé', 'sync');
            
            // ä¾æ¬¡é‹è¡Œå…¶ä»–æ¸¬è©¦
            await testDataSync();
            setTimeout(testResourceLock, 1000);
            
            log('ğŸ‰ å…¨éƒ¨æ¸¬è©¦å®Œæˆï¼', 'sync');
            updateTestProgress();
        }
        
        function clearEvents() {
            document.getElementById('eventLog').innerHTML = `
                <div class="event-entry">
                    <span class="event-timestamp">[--:--:--]</span>
                    <span class="event-instance">ç³»çµ±</span>
                    <span class="event-type info">ä¿¡æ¯</span>
                    <span>äº‹ä»¶æ—¥èªŒå·²æ¸…ç©º</span>
                </div>
            `;
        }
        
        // å¹«åŠ©å°è©±æ¡†
        function showHelp() {
            document.getElementById('helpModal').classList.add('active');
        }
        
        function closeHelp() {
            document.getElementById('helpModal').classList.remove('active');
        }
        
        // é»æ“Šæ¨¡æ…‹æ¡†èƒŒæ™¯é—œé–‰
        document.getElementById('helpModal').addEventListener('click', (e) => {
            if (e.target.id === 'helpModal') {
                closeHelp();
            }
        });
        
        // ESCéµé—œé–‰æ¨¡æ…‹æ¡†
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeHelp();
            }
        });
    </script>
</body>
</html>


